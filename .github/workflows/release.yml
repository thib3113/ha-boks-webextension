name: Build and Publish Extension

on:
  release:
    types: [published]

jobs:
  build-and-attach:
    name: Build and Attach Assets
    runs-on: ubuntu-latest
    permissions:
      contents: write # Requis pour uploader les assets dans la release

    steps:
      # 1. Checkout code
      - name: Checkout code
        uses: actions/checkout@v4

      # 2. Setup Node.js (for crx3)
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 'lts/*'

      # 3. Build Chrome ZIP
      # On garde le manifest.json original (MV3 Chrome standard)
      - name: Create Chrome ZIP
        run: |
          zip -r chrome-extension.zip . -x "*.git*" -x ".github/*" -x "*.pem" -x "*.DS_Store"
          echo "Chrome ZIP created."

      # 4. Build Firefox ZIP (Specialized)
      - name: Create Firefox ZIP
        run: |
          mkdir firefox_dist
          # Copie propre des fichiers
          rsync -av --exclude='chrome-extension.zip' --exclude='.git' --exclude='.github' . firefox_dist/

          cd firefox_dist

          jq '.browser_specific_settings = { "gecko": { "id": "55082b69-ecc1-46ce-8dcd-90c30df203b1" } }' manifest.json > manifest.tmp && mv manifest.tmp manifest.json
          
          zip -r ../firefox-extension.xpi .
          cd ..
          rm -rf firefox_dist
          echo "Firefox ZIP created."

      - name: Install CRX tool and Pack
        id: pack_crx
        env:
          CRX_PRIVATE_KEY: ${{ secrets.CRX_KEY }}
        run: |
          if [ -z "${CRX_PRIVATE_KEY:-}" ]; then
            echo "No CRX private key supplied â€” skipping CRX pack step."
            exit 0
          fi

          npm install -g crx3

          printf '%s\n' "$CRX_PRIVATE_KEY" > private.pem
          chmod 600 private.pem

          crx3 pack . -p private.pem -o extension.crx \
            -x ".git" -x ".github" -x "chrome-extension.zip" -x "firefox-extension.zip" -x "private.pem"

          shred -u private.pem || rm -f private.pem
          echo "CRX created."

      - name: Upload Assets to Release
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const { repo, owner } = context.repo;
            const releaseId = context.payload.release.id;
            
            console.log(`Uploading assets to release ID: ${releaseId}`);
            
            const files = ['chrome-extension.zip', 'firefox-extension.zip', 'extension.crx'];
            
            for (const file of files) {
              if (fs.existsSync(file)) {
                console.log(`Uploading ${file}...`);
                await github.rest.repos.uploadReleaseAsset({
                  owner,
                  repo,
                  release_id: releaseId,
                  name: file,
                  data: fs.readFileSync(file)
                });
              } else {
                console.log(`File ${file} skipped (not found).`);
              }
            }
