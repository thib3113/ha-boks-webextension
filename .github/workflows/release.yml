name: Build, Sign and Publish Extension

# Trigger on published releases
on:
  release:
    types: [published]

# Grant id-token so cosign keyless can use OIDC (kept for signatures)
permissions:
  contents: write
  id-token: write

jobs:
  build-and-attach:
    name: Build, Sign and Attach Assets (ZIP + XPI)
    runs-on: ubuntu-latest
    permissions:
      contents: write
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js & tools
        uses: actions/setup-node@v4
        with:
          node-version: 'lts/*'

      - name: Prepare build directories (copy only src)
        run: |
          set -euo pipefail
          rm -rf build firefox_dist chrome_build provenance
          mkdir -p build chrome_build firefox_dist provenance

          # Copy extension source to a clean build dir (avoid .github, .git, node_modules, etc.)
          rsync -a --delete --exclude='.git' --exclude='.github' --exclude='node_modules' src/ chrome_build/
          rsync -a --delete --exclude='.git' --exclude='.github' --exclude='node_modules' src/ firefox_dist/

          echo "Prepared chrome_build/ and firefox_dist/ from src/"
        shell: bash

      - name: Create Firefox XPI
        run: |
          set -euo pipefail
          cd firefox_dist

          if [ -f manifest.json ]; then
            # Add browser_specific_settings.gecko.id if not present
            if ! jq -e '.browser_specific_settings.gecko.id' manifest.json >/dev/null 2>&1; then
              jq '.browser_specific_settings = { "gecko": { "id": "55082b69-ecc1-46ce-8dcd-90c30df203b1" } }' manifest.json > manifest.tmp && mv manifest.tmp manifest.json
            fi
          fi

          FIREFOX_NAME="firefox-ha-boks-extension.xpi"
          zip -r "../${FIREFOX_NAME}" .
          cd ..
          echo "Created ${FIREFOX_NAME}"
        shell: bash

      - name: Create Chrome/Chromium ZIP (ha-boks-extension.zip)
        run: |
          set -euo pipefail
          if [ -d chrome_build ]; then
            cd chrome_build
            zip -r ../ha-boks-extension.zip .
            cd ..
            echo "Created ha-boks-extension.zip"
          else
            echo "chrome_build not found, skipping zip creation"; exit 1
          fi
        shell: bash

      - name: Install cosign (pinned) with fallback
        run: |
          set -euo pipefail
          COSIGN_VERSION="v2.4.1"
          COSIGN_BIN="/usr/local/bin/cosign"

          if curl -fSL "https://github.com/sigstore/cosign/releases/download/${COSIGN_VERSION}/cosign-linux-amd64" -o "$COSIGN_BIN"; then
            chmod +x "$COSIGN_BIN"
          else
            if command -v docker >/dev/null 2>&1; then
              docker run --rm --entrypoint cat "ghcr.io/sigstore/cosign/cosign:${COSIGN_VERSION}" /ko-app/cosign > "$COSIGN_BIN"
              chmod +x "$COSIGN_BIN"
            else
              echo "ERROR: could not download cosign and docker not available for fallback. Exiting."; exit 2
            fi
          fi

          echo "COSIGN_BIN=$COSIGN_BIN" >> "$GITHUB_ENV"
        shell: bash

      - name: Sign artifacts with cosign (non-interactive via Actions OIDC) and record provenance
        if: success()
        env:
          COSIGN_EXPERIMENTAL: "1"
          RELEASE_TAG: ${{ github.event.release.tag_name }}
          GITHUB_SERVER_URL: ${{ github.server_url }}
          GITHUB_REPOSITORY: ${{ github.repository }}
        run: |
          set -euo pipefail
          COSIGN_BIN="${COSIGN_BIN:-/usr/local/bin/cosign}"
          mkdir -p provenance

          ZIP_NAME="ha-boks-extension.zip"
          FIREFOX_NAME="firefox-ha-boks-extension.xpi"

          artifacts=(
            "${ZIP_NAME}"
            "${FIREFOX_NAME}"
          )

          # Build recommended regexps for certificate verification (used in CI verification output)
          CERT_IDENTITY_REGEXP="${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}.*"
          CERT_OIDC_ISSUER_REGEXP="https://token.actions.githubusercontent.com.*"

          echo "Using certificate identity regexp: $CERT_IDENTITY_REGEXP"
          echo "Using certificate oidc issuer regexp: $CERT_OIDC_ISSUER_REGEXP"

          for f in "${artifacts[@]}"; do
            if [ ! -f "$f" ]; then
              echo "Warning: $f not found, skipping signing."
              continue
            fi

            sig="${f}.sig"
            cert="${f}.cert"
            prov="provenance/${f}.verify.txt"

            echo "Signing $f -> $sig (non-interactive; cosign will use Actions OIDC if available)"
            "$COSIGN_BIN" sign-blob -y --oidc-provider github-actions --output-signature "$sig" --output-certificate "$cert" "$f"

            echo "Verifying $f and saving output to $prov"
            "$COSIGN_BIN" verify-blob --signature "$sig" --cert "$cert" --certificate-identity-regexp "$CERT_IDENTITY_REGEXP" --certificate-oidc-issuer-regexp "$CERT_OIDC_ISSUER_REGEXP" "$f" 2>&1 | tee "$prov"

            echo "Signed $f -> $sig and $cert; verification written to $prov"
          done
        shell: bash

      - name: List artifacts for debug
        run: |
          echo "Artifacts in workspace:"
          ls -alh
          test -f ha-boks-extension.zip && unzip -l ha-boks-extension.zip || true
          test -f firefox-ha-boks-extension.xpi && unzip -l firefox-ha-boks-extension.xpi || true
          echo "--- provenance files ---"
          ls -alh provenance || true
        shell: bash

      - name: Upload Assets to Release (including signatures & provenance)
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const { repo, owner } = context.repo;
            const releaseId = context.payload.release.id;
            console.log(`Uploading assets to release ID: ${releaseId}`);

            const files = [
              'ha-boks-extension.zip',
              'ha-boks-extension.zip.sig',
              'ha-boks-extension.zip.cert',
              'provenance/ha-boks-extension.zip.verify.txt',

              'firefox-ha-boks-extension.xpi',
              'firefox-ha-boks-extension.xpi.sig',
              'firefox-ha-boks-extension.xpi.cert',
              'provenance/firefox-ha-boks-extension.xpi.verify.txt'
            ];

            for (const file of files) {
              if (fs.existsSync(file)) {
                console.log(`Uploading ${file}...`);
                await github.rest.repos.uploadReleaseAsset({
                  owner,
                  repo,
                  release_id: releaseId,
                  name: file,
                  data: fs.readFileSync(file)
                });
                console.log(`Uploaded ${file}`);
              } else {
                console.log(`File ${file} skipped (not found).`);
              }
            }
        env:
          RELEASE_TAG: ${{ github.event.release.tag_name }}
          GITHUB_SERVER_URL: ${{ github.server_url }}
          GITHUB_REPOSITORY: ${{ github.repository }}

      - name: Append short verification note to release notes
        uses: actions/github-script@v7
        env:
          RELEASE_TAG: ${{ github.event.release.tag_name }}
          GITHUB_SERVER_URL: ${{ github.server_url }}
          GITHUB_REPOSITORY: ${{ github.repository }}
        with:
          script: |
            const { owner, repo } = context.repo;
            const releaseId = context.payload.release.id;
            const tag = process.env.RELEASE_TAG || context.payload.release.tag_name || '';
            const base = `${process.env.GITHUB_SERVER_URL}/${process.env.GITHUB_REPOSITORY}/releases/download/${tag}`;

              console.log('Release notes updated with short verification info.');
              '```',
              '# ZIP:',
              `cosign verify-blob --signature ha-boks-extension.zip.sig --certificate-identity-regexp \"${certRegexp}\" --certificate-oidc-issuer-regexp \"${issuerRegexp}\" ${base}/ha-boks-extension.zip`,
              '# Firefox XPI:',
              `cosign verify-blob --signature firefox-ha-boks-extension.xpi.sig --certificate-identity-regexp \"${certRegexp}\" --certificate-oidc-issuer-regexp \"${issuerRegexp}\" ${base}/firefox-ha-boks-extension.xpi`,
              '```',
              'You can also inspect the attached provenance files (provenance/*.verify.txt) which contain the detailed verification output (claims, Rekor entry).',
              '',
              'Quick docs: https://github.com/sigstore/cosign',
              ''
            ].join('\n');

            const current = context.payload.release.body || '';
            const newBody = current + '\n\n' + verificationBlock;

            await github.rest.repos.updateRelease({
              owner,
              repo,
              release_id: releaseId,
              body: newBody
            });

            console.log('Release notes updated with short verification info.');
              '```',
              `# ZIP:`,
              `cosign verify-blob --signature ha-boks-extension.zip.sig --certificate-identity-regexp \"${certRegexp}\" --certificate-oidc-issuer-regexp \"${issuerRegexp}\" ${base}/ha-boks-extension.zip`,
              `# Firefox XPI:`,
              `cosign verify-blob --signature firefox-ha-boks-extension.xpi.sig --certificate-identity-regexp \"${certRegexp}\" --certificate-oidc-issuer-regexp \"${issuerRegexp}\" ${base}/firefox-ha-boks-extension.xpi`,
              '```',
              'You can also inspect the attached provenance files (provenance/*.verify.txt) which contain the detailed verification output (claims, Rekor entry).',
              '',
              'Quick docs: https://github.com/sigstore/cosign',
              ''
            ].join('\n');

            const current = context.payload.release.body || '';
            const newBody = current + '\n\n' + verificationBlock;

            await github.rest.repos.updateRelease({
              owner,
              repo,
              release_id: releaseId,
              body: newBody
            });
