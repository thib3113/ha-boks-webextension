name: Build, Attest and Publish Extension

on:
  push:
    tags:
      - 'v*'

# Grant permissions for GitHub Attestations
permissions:
  contents: write
  id-token: write
  attestations: write
  artifact-metadata: write

jobs:
  build-and-attach:
    name: Build, Attest and Attach Assets (ZIP + XPI)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
        with:
          fetch-depth: 0

      - name: Setup Node.js & tools
        uses: actions/setup-node@395ad3262231945c25e8478fd5baf05154b1d79f # v6
        with:
          node-version: 'lts/*'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Validate version consistency and lint manifest
        run: |
          # Check if manifest is valid JSON
          jq . src/manifest.json > /dev/null
          
          # Read version from package.json
          PKG_VERSION=$(jq -r '.version' package.json)
          TAG_VERSION=${GITHUB_REF_NAME#v}
          
          echo "Package version: $PKG_VERSION"
          echo "Tag version: $TAG_VERSION"
          
          if [ "$PKG_VERSION" != "$TAG_VERSION" ]; then
            echo "ERROR: Version mismatch!"
            echo "The version in package.json ($PKG_VERSION) does not match the release tag ($TAG_VERSION)."
            echo "Please update package.json before creating the release."
            exit 1
          fi
        shell: bash

      - name: Build Extension
        run: npm run build

      - name: Prepare build directories (copy from dist)
        run: |
          set -euo pipefail
          rm -rf build firefox_dist chrome_build
          mkdir -p build chrome_build firefox_dist

          # Copy built extension from dist/extension/ to build dirs
          rsync -a --delete dist/extension/ chrome_build/
          rsync -a --delete dist/extension/ firefox_dist/

          echo "Prepared chrome_build/ and firefox_dist/ from dist/extension/"
        shell: bash

      - name: Create Firefox XPI
        run: |
          set -euo pipefail
          cd firefox_dist

          if [ -f manifest.json ]; then
            # Add browser_specific_settings.gecko.id if not present
            if ! jq -e '.browser_specific_settings.gecko.id' manifest.json >/dev/null 2>&1; then
              jq '.browser_specific_settings = { "gecko": { "id": "55082b69-ecc1-46ce-8dcd-90c30df203b1" } }' manifest.json > manifest.tmp && mv manifest.tmp manifest.json
            fi
          fi

          FIREFOX_NAME="firefox-ha-boks-extension.xpi"
          zip -r "../${FIREFOX_NAME}" .
          cd ..
          echo "Created ${FIREFOX_NAME}"
        shell: bash

      - name: Create Chrome/Chromium ZIP (ha-boks-extension.zip)
        run: |
          set -euo pipefail
          if [ -d chrome_build ]; then
            cd chrome_build
            zip -r ../ha-boks-extension.zip .
            cd ..
            echo "Created ha-boks-extension.zip"
          else
            echo "chrome_build not found, skipping zip creation"; exit 1
          fi
        shell: bash

      - name: Prepare Userscript
        run: cp dist/userscript/boks.user.js .

      - name: Generate Checksums
        run: |
          shasum -a 256 ha-boks-extension.zip firefox-ha-boks-extension.xpi boks.user.js > checksums.txt
          find dist/extension -type f -exec shasum -a 256 {} + >> checksums.txt
        shell: bash


      - name: Attest Build Provenance
        id: attest
        uses: actions/attest-build-provenance@977bb373ede98d70efdf65b84cb5f73e068dcc2a # v3
        with:
          subject-checksums: checksums.txt

      - name: List artifacts for debug
        run: |
          echo "Artifacts in workspace:"
          ls -alh
          test -f ha-boks-extension.zip && unzip -l ha-boks-extension.zip || true
          test -f firefox-ha-boks-extension.xpi && unzip -l firefox-ha-boks-extension.xpi || true
          test -f boks.user.js && head -n 5 boks.user.js || true
          test -f checksums.txt && cat checksums.txt || true
        shell: bash

      - name: Create Release and Upload Assets
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8
        env:
          TAG_NAME: ${{ github.ref_name }}
          ATTESTATION_URL: ${{ steps.attest.outputs.attestation-url }}
          REPO_OWNER: ${{ github.repository_owner }}
          REPO_NAME: ${{ github.event.repository.name }}
          RUN_ID: ${{ github.run_id }}
          SERVER_URL: ${{ github.server_url }}
        with:
          script: |
            const fs = require('fs');
            const { 
              TAG_NAME, ATTESTATION_URL, REPO_OWNER, 
              REPO_NAME, RUN_ID, SERVER_URL 
            } = process.env;

            console.log(`Processing release for tag: ${TAG_NAME}`);

            // 1. Get or Create the Release
            let release;
            try {
              console.log('Creating release...');
              const r = await github.rest.repos.createRelease({
                owner: REPO_OWNER,
                repo: REPO_NAME,
                tag_name: TAG_NAME,
                name: `Release ${TAG_NAME}`,
                draft: false,
                prerelease: false,
                generate_release_notes: true
              });
              release = r.data;
              console.log(`Created release ID: ${release.id}`);
            } catch (e) {
              // If release already exists (e.g. re-run), fetch it
              if (e.status === 422) {
                console.log('Release already exists, fetching it...');
                const r = await github.rest.repos.getReleaseByTag({ owner: REPO_OWNER, repo: REPO_NAME, tag: TAG_NAME });
                release = r.data;
                console.log(`Found existing release ID: ${release.id}`);
              } else {
                throw e;
              }
            }

            const releaseId = release.id;

            // 2. Upload Assets
            const files = [
              'ha-boks-extension.zip',
              'firefox-ha-boks-extension.xpi',
              'boks.user.js',
              'checksums.txt'
            ];

            for (const fileName of files) {
              if (fs.existsSync(fileName)) {
                console.log(`Handling asset: ${fileName}`);
                
                // Delete existing asset if it exists (allows reruns)
                const existingAsset = release.assets.find(a => a.name === fileName);
                if (existingAsset) {
                    console.log(`Deleting existing asset ${fileName} (ID: ${existingAsset.id})...`);
                    await github.rest.repos.deleteReleaseAsset({ owner: REPO_OWNER, repo: REPO_NAME, asset_id: existingAsset.id });
                }

                console.log(`Uploading ${fileName}...`);
                await github.rest.repos.uploadReleaseAsset({
                  owner: REPO_OWNER,
                  repo: REPO_NAME,
                  release_id: releaseId,
                  name: fileName,
                  data: fs.readFileSync(fileName),
                  headers: {
                    'content-type': fileName.endsWith('.zip') ? 'application/zip' : 
                                   fileName.endsWith('.xpi') ? 'application/x-xpinstall' : 'text/plain',
                    'content-length': fs.statSync(fileName).size
                  }
                });
              }
            }

            // 3. Update body with Attestation info
            const verificationBlock = `
            ---
            ### üõ°Ô∏è Security & Provenance
            This release includes signed build provenance attestations.
            - **Official Attestation**: [Verify on GitHub](${ATTESTATION_URL})
            - **Manual Verification**:
              \`\`\`bash
              # Verify the artifacts using the checksums file
              shasum -a 256 -c checksums.txt
              # Verify the attestation via GitHub CLI
              gh attestation verify ha-boks-extension.zip --repo ${REPO_OWNER}/${REPO_NAME}
              gh attestation verify firefox-ha-boks-extension.xpi --repo ${REPO_OWNER}/${REPO_NAME}
              gh attestation verify boks.user.js --repo ${REPO_OWNER}/${REPO_NAME}
              \`\`\`
            **Workflow Run**: [Execution #${RUN_ID}](${SERVER_URL}/${REPO_OWNER}/${REPO_NAME}/actions/runs/${RUN_ID})`;

            const currentBody = release.body || '';
            if (!currentBody.includes("Security & Provenance")) {
                console.log('Updating release body with provenance info...');
                await github.rest.repos.updateRelease({
                  owner: REPO_OWNER,
                  repo: REPO_NAME,
                  release_id: releaseId,
                  body: currentBody + '\n\n' + verificationBlock
                });
            } else {
                console.log('Release body already contains provenance info, skipping update.');
            }
