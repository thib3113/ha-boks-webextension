name: Build, Attest and Publish Extension

# Trigger on published releases
on:
  release:
    types: [published]

# Grant permissions for GitHub Attestations
permissions:
  contents: write
  id-token: write
  attestations: write
  artifact-metadata: write

jobs:
  build-and-attach:
    name: Build, Attest and Attach Assets (ZIP + XPI)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js & tools
        uses: actions/setup-node@v4
        with:
          node-version: 'lts/*'

      - name: Install dependencies
        run: npm ci

      - name: Validate version consistency and lint manifest
        run: |
          # Check if manifest is valid JSON
          jq . src/manifest.json > /dev/null
          
          # Read version from package.json
          PKG_VERSION=$(jq -r '.version' package.json)
          TAG_VERSION=${GITHUB_REF_NAME#v}
          
          echo "Package version: $PKG_VERSION"
          echo "Tag version: $TAG_VERSION"
          
          if [ "$PKG_VERSION" != "$TAG_VERSION" ]; then
            echo "ERROR: Version mismatch!"
            echo "The version in package.json ($PKG_VERSION) does not match the release tag ($TAG_VERSION)."
            echo "Please update package.json before creating the release."
            exit 1
          fi
        shell: bash

      - name: Build Extension
        run: npm run build

      - name: Prepare build directories (copy from dist)
        run: |
          set -euo pipefail
          rm -rf build firefox_dist chrome_build
          mkdir -p build chrome_build firefox_dist

          # Copy built extension from dist/ to build dirs
          # Note: The build script (npm run build) already puts everything in dist/
          rsync -a --delete dist/ chrome_build/
          rsync -a --delete dist/ firefox_dist/

          echo "Prepared chrome_build/ and firefox_dist/ from dist/"
        shell: bash

      - name: Create Firefox XPI
        run: |
          set -euo pipefail
          cd firefox_dist

          if [ -f manifest.json ]; then
            # Add browser_specific_settings.gecko.id if not present
            if ! jq -e '.browser_specific_settings.gecko.id' manifest.json >/dev/null 2>&1; then
              jq '.browser_specific_settings = { "gecko": { "id": "55082b69-ecc1-46ce-8dcd-90c30df203b1" } }' manifest.json > manifest.tmp && mv manifest.tmp manifest.json
            fi
          fi

          FIREFOX_NAME="firefox-ha-boks-extension.xpi"
          zip -r "../${FIREFOX_NAME}" .
          cd ..
          echo "Created ${FIREFOX_NAME}"
        shell: bash

      - name: Create Chrome/Chromium ZIP (ha-boks-extension.zip)
        run: |
          set -euo pipefail
          if [ -d chrome_build ]; then
            cd chrome_build
            zip -r ../ha-boks-extension.zip .
            cd ..
            echo "Created ha-boks-extension.zip"
          else
            echo "chrome_build not found, skipping zip creation"; exit 1
          fi
        shell: bash

      - name: Generate Checksums
        run: shasum -a 256 ha-boks-extension.zip firefox-ha-boks-extension.xpi > checksums.txt

      - name: Attest Build Provenance
        id: attest
        uses: actions/attest-build-provenance@v3
        with:
          subject-checksums: checksums.txt

      - name: List artifacts for debug
        run: |
          echo "Artifacts in workspace:"
          ls -alh
          test -f ha-boks-extension.zip && unzip -l ha-boks-extension.zip || true
          test -f firefox-ha-boks-extension.xpi && unzip -l firefox-ha-boks-extension.xpi || true
          test -f checksums.txt && cat checksums.txt || true
        shell: bash

      - name: Upload Assets to Release (including checksums)
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const { repo, owner } = context.repo;
            const releaseId = context.payload.release.id;
            console.log(`Uploading assets to release ID: ${releaseId}`);

            const files = [
              'ha-boks-extension.zip',
              'firefox-ha-boks-extension.xpi',
              'checksums.txt'
            ];

            for (const file of files) {
              if (fs.existsSync(file)) {
                console.log(`Uploading ${file}...`);
                await github.rest.repos.uploadReleaseAsset({
                  owner,
                  repo,
                  release_id: releaseId,
                  name: file,
                  data: fs.readFileSync(file),
                  headers: {
                    'content-type': file.endsWith('.zip') ? 'application/zip' : 
                                   file.endsWith('.xpi') ? 'application/x-xpinstall' : 'text/plain',
                    'content-length': fs.statSync(file).size
                  }
                });
                console.log(`Uploaded ${file}`);
              } else {
                console.log(`File ${file} skipped (not found).`);
              }
            }
        env:
          RELEASE_TAG: ${{ github.event.release.tag_name }}
          GITHUB_SERVER_URL: ${{ github.server_url }}
          GITHUB_REPOSITORY: ${{ github.repository }}

      - name: Append verification note to release notes
        uses: actions/github-script@v7
        env:
          RELEASE_TAG: ${{ github.event.release.tag_name }}
          GITHUB_SERVER_URL: ${{ github.server_url }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          ATTESTATION_URL: ${{ steps.attest.outputs.attestation-url }}
          RUN_ID: ${{ github.run_id }}
        with:
          script: |
            const { owner, repo } = context.repo;
            const releaseId = context.payload.release.id;
            const { ATTESTATION_URL, RUN_ID, GITHUB_SERVER_URL, GITHUB_REPOSITORY } = process.env;

            console.log('Updating release notes with attestation info...');
            const verificationBlock = `
            ---
            ### üõ°Ô∏è Security & Provenance
            This release includes signed build provenance attestations.
            - **Official Attestation**: [Verify on GitHub](${ATTESTATION_URL})
            - **Manual Verification**:
              \`\`\`bash
              # Verify the artifacts using the checksums file
              shasum -a 256 -c checksums.txt
              # Verify the attestation via GitHub CLI
              gh attestation verify ha-boks-extension.zip --repo ${owner}/${repo}
              gh attestation verify firefox-ha-boks-extension.xpi --repo ${owner}/${repo}
              \`\`\`
            **Workflow Run**: [Execution #${RUN_ID}](${GITHUB_SERVER_URL}/${owner}/${repo}/actions/runs/${RUN_ID})`;

            const current = context.payload.release.body || '';
            const newBody = current + '\n\n' + verificationBlock;

            await github.rest.repos.updateRelease({
              owner,
              repo,
              release_id: releaseId,
              body: newBody
            });

            console.log('Release notes updated.');
